<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

	<script type="text/javascript" th:fragment="javascript">

$(document).ready(function(){
	
	$("#createAt").change(function(){
		var valor = $("#createAt").val();
		if (valor && valor.length>0) { 
			 $("#buscar_producto").prop("disabled",false);
		} else {
			 $("#buscar_producto").prop("disabled",true);
		}
	});
		
	$("#buscar_producto").autocomplete({
	
		source: function(request, response){			
			$.ajax({
				url: "/planificacione/cargar-productos/"+ request.term+"/"+$("#createAt").val(),
				dataType: "json",
				data: {
					term: request.term,
					createAt : $("#createAt").val()
				},
				success: function(data){
					response($.map(data, function(item){
						return {
							value: item.id,
							label: item.nombre,
							cantidad: item.cantidad,
						};
					}));
				},
			});
		},
		select: function(event, ui){
			//$("#buscar_producto").val(ui.item.label);
			
			if(itemsHelper.hasProducto(ui.item.value)){
				itemsHelper.incrementaCantidad(ui.item.value);
				return false;
			}
			
			var linea = $("#plantillaItemsPlanificacione").html();
			
			linea = linea.replace(/{ID}/g, ui.item.value);
			linea = linea.replace(/{NOMBRE}/g, ui.item.label);
			linea = linea.replace(/{CANTIDAD}/g, ui.item.cantidad);		
			
			$("#cargarItemPlanificacione tbody").append(linea);	
			
			if(ui.item.cantidad==0){
				$("#cantidad_" + ui.item.value).prop('min',0);
				$("#cantidad_" + ui.item.value).prop('max',0); 
			} else {
				$("#cantidad_" + ui.item.value).prop('min',1); 
				$("#cantidad_" + ui.item.value).prop('max',ui.item.cantidad); 
			}
			 			
			return false;
		}
	});
	
	$("form[name='formFactura']").submit(function(){
		$("#plantillaItemsPlanificacione").remove();
		return;
	});

});
    
    var itemsHelper = {
    	hasProducto: function(id){
    	
    		var resultado = false;
    		$('input[name="item_id[]"').each(function(){
    			if(parseInt(id) == parseInt($(this).val())){
    				resultado = true;
    			}
    	     });
    	     return resultado;	
       },
       incrementaCantidad: function(id){
       		var cantidad = $("#cantidad_" + id).val() ? parseInt($("#cantidad_" + id).val()) :0;
       		$("#cantidad_" + id).val(++cantidad); 		
       		
       },
       eliminarLineaFactura: function(id){
       	    $("#row_" + id).remove();
       }
    }
    
	</script>

</body>
</html>